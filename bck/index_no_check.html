<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Radio Player</title>
    <!-- FIX: Load Tailwind library BEFORE the configuration script -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Three.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Library for parsing stream metadata -->
    <script src="https://cdn.jsdelivr.net/npm/icecast-metadata-player@2.0.0/dist/icecast-metadata-player.main.js"></script>
    <!-- Library for Drag and Drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.5);
            border-radius: 10px;
        }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(71, 85, 105, 0.7);
        }
        .station-item.active {
            background-color: rgba(79, 70, 229, 0.8); /* indigo-600 with opacity */
            color: white;
        }
        .dark .station-item.active {
             background-color: rgba(99, 102, 241, 0.7); /* indigo-500 with opacity */
        }
        #visualizer-container {
            height: 128px; /* 8rem */
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.5rem;
            cursor: grab;
        }
        #now-playing-title {
            height: 2.5rem;
            line-height: 1.25rem;
        }
        .favorite-star {
            color: #cbd5e1; /* slate-300 */
            transition: color 0.2s ease-in-out;
        }
        .favorite-star.favorited, .favorite-star:hover {
            color: #facc15; /* yellow-400 */
        }
        .drag-handle {
            cursor: grab;
            margin-right: 10px;
            color: #94a3b8; /* slate-400 */
        }
        .sortable-ghost {
            opacity: 0.4;
            background: rgba(224, 231, 255, 0.5); /* indigo-100 with opacity */
        }
    </style>
    <script>
        // Set theme on initial load
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark')
        } else {
            document.documentElement.classList.remove('dark')
        }
    </script>
</head>
<body class="bg-gradient-to-br from-indigo-200 via-purple-200 to-pink-200 dark:from-indigo-900/80 dark:via-purple-900/80 dark:to-slate-900 text-slate-800 dark:text-slate-200 flex items-center justify-center min-h-screen p-4 transition-colors duration-300">

    <div class="w-full max-w-4xl mx-auto bg-white/30 dark:bg-slate-800/50 backdrop-blur-xl border border-white/20 rounded-2xl shadow-2xl overflow-hidden flex flex-col-reverse md:flex-row transition-colors duration-300 h-full md:h-[600px]">

        <!-- Station List -->
        <aside class="w-full md:w-1/3 bg-white/20 dark:bg-slate-900/30 border-t md:border-t-0 md:border-r border-white/20 dark:border-slate-700/50 flex flex-col transition-colors duration-300">
            <header class="p-4 border-b border-white/20 dark:border-slate-700/50 flex items-center justify-between">
                <h2 class="text-xl font-bold text-slate-700 dark:text-slate-200">Hi-Fi Radio</h2>
                <div class="flex items-center">
                    <select id="viz-select" class="bg-white/50 dark:bg-slate-800/60 border border-slate-300/50 dark:border-slate-600/80 rounded-md text-sm p-1 mr-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-slate-700 dark:text-slate-200">
                        <option value="bars">3D Bars</option>
                        <option value="wave">Wave Field</option>
                        <option value="sphere">Sphere</option>
                    </select>
                    <button id="theme-toggle" title="Toggle Theme" class="text-slate-500 hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors">
                        <i class="fas fa-sun"></i>
                        <i class="fas fa-moon hidden"></i>
                    </button>
                </div>
            </header>
            <div class="p-2 border-b border-white/20 dark:border-slate-700/50">
                <input type="search" id="search-input" placeholder="Search stations..." class="w-full px-3 py-2 bg-white/50 dark:bg-slate-800/60 border border-slate-300/50 dark:border-slate-600/80 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 placeholder-slate-500 dark:placeholder-slate-400">
            </div>
            <nav id="station-list" class="flex-1 overflow-y-auto custom-scrollbar">
                <!-- Stations will be populated by JavaScript -->
            </nav>
        </aside>

        <!-- Player Section -->
        <main id="main-player" class="w-full md:w-2/3 p-6 sm:p-8 flex flex-col transition-all duration-500 bg-cover bg-center">
            <div id="player-content" class="text-center flex-1 flex flex-col items-center justify-center transition-opacity duration-500">
                <div id="visualizer-container">
                    <!-- The icon or the visualizer will be placed here by JS -->
                </div>
                <h1 id="info-name" class="text-3xl font-bold text-slate-800 dark:text-white">Select a Station</h1>
                <div id="now-playing-title" class="text-slate-600 dark:text-slate-300 mt-2 text-lg font-medium">
                    <p id="info-genre">Your music awaits</p>
                </div>
                <p id="info-quality" class="text-sm text-slate-500 dark:text-slate-400 mt-4"></p>
            </div>
            <div class="mt-auto">
                <audio id="audio-player" controls crossOrigin="anonymous" class="w-full">
                    Your browser does not support the audio element.
                </audio>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let stations = [
                { name: 'Cavo Paradiso', url: 'https://live.cavoparadiso.gr/stream', genre: 'Deep & Progressive House', quality: 'MP3 192kbps' },
                { name: 'Ibiza Global Radio', url: 'https://listenssl.ibizaglobalradio.com/live', genre: 'House, Tech House', quality: 'MP3 320kbps' },
                { name: 'Intense Radio', url: 'https://intenseradio.net/128.mp3', genre: 'Dance, Trance, Techno', quality: 'MP3 128kbps' },
                { name: 'Proton Radio', url: 'https://shoutcast.protonradio.com/;', genre: 'Progressive House', quality: 'MP3 320kbps' },
                { name: 'DI.FM - Vocal Trance', url: 'https://listen.di.fm/vocaltrance', genre: 'Vocal Trance', quality: 'MP3 320kbps' },
                { name: 'DI.FM - EDM Hits', url: 'https://listen.di.fm/edm', genre: 'EDM, Dance, Progressive', quality: 'MP3 320kbps' },
                { name: 'The Jazz Groove', url: 'https://stream.thejazzgroove.com/stream', genre: 'Laid-back Jazz', quality: 'AAC 128kbps' },
                { name: 'Jazz24', url: 'https://d.live.knkx.org/knkx-256k-aac', genre: 'Classic & Modern Jazz', quality: 'AAC 256kbps' },
                { name: 'Naim Jazz', url: 'https://mscp3.live-streams.nl:8360/mp3.mp3', genre: 'Contemporary & Classic Jazz', quality: 'MP3 320kbps' },
                { name: 'Absolute Radio 70s', url: 'https://listen.absoluteradio.co.uk/absolute70s.mp3', genre: '70s Rock & Pop', quality: 'MP3 128kbps' },
                { name: 'Absolute Radio 80s', url: 'https://listen.absoluteradio.co.uk/absolute80s.mp3', genre: '80s Pop & Rock', quality: 'MP3 128kbps' },
                { name: 'Dance Wave Retro!', url: 'https://dancewaveretro.com/dancewaveretro.flac', genre: '80s & 90s Dance', quality: 'FLAC (Lossless)' },
                { name: 'PulsRadio 2000', url: 'http://listen.pulsradio.com/2000.mp3', genre: '00s Dance & Pop', quality: 'MP3 192kbps' },
                { name: 'PulsRadio 2010', url: 'http://listen.pulsradio.com/2010.mp3', genre: '10s Dance & Pop', quality: 'MP3 192kbps' },
                { name: 'Radio Paradise (Main)', url: 'https://stream.radioparadise.com/flac', genre: 'Eclectic Rock, Pop, Jazz', quality: 'FLAC (Lossless)' }
            ];

            // --- PAGE ELEMENT REFERENCES ---
            const stationList = document.getElementById('station-list');
            const audioPlayer = document.getElementById('audio-player');
            const infoName = document.getElementById('info-name');
            const infoGenre = document.getElementById('info-genre');
            const infoQuality = document.getElementById('info-quality');
            const visualizerContainer = document.getElementById('visualizer-container');
            const themeToggleButton = document.getElementById('theme-toggle');
            const vizSelect = document.getElementById('viz-select');
            const searchInput = document.getElementById('search-input');

            // --- PLAYER STATE ---
            let audioContext, analyser, sourceNode;
            let visualizerInitialized = false;
            let metadataPlayer;
            let currentViz = 'bars';
            let currentStation = null;
            let stationsToShow = 10;
            let isLazyLoadingEnabled = true;

            // --- FAVORITES & SORTING ---
            let favorites = [];

            function loadStoredData() {
                const storedFavorites = localStorage.getItem('radioFavorites');
                favorites = storedFavorites ? JSON.parse(storedFavorites) : [];
                stations.forEach(station => {
                    station.isFavorite = favorites.includes(station.name);
                });

                const storedOrder = localStorage.getItem('radioSortOrder');
                if (storedOrder) {
                    const orderedNames = JSON.parse(storedOrder);
                    const stationMap = new Map(stations.map(s => [s.name, s]));
                    const orderedStations = orderedNames.map(name => stationMap.get(name)).filter(Boolean);
                    const newStations = stations.filter(s => !orderedNames.includes(s.name));
                    stations = [...orderedStations, ...newStations];
                }

                currentViz = localStorage.getItem('radioViz') || 'bars';
                vizSelect.value = currentViz;
            }

            function saveFavorites() {
                localStorage.setItem('radioFavorites', JSON.stringify(favorites));
            }
            
            function saveOrder() {
                const orderedNames = stations.map(s => s.name);
                localStorage.setItem('radioSortOrder', JSON.stringify(orderedNames));
            }

            function toggleFavorite(stationName) {
                const favIndex = favorites.indexOf(stationName);
                if (favIndex > -1) {
                    favorites.splice(favIndex, 1);
                } else {
                    favorites.push(stationName);
                }
                saveFavorites();
                loadStoredData();
                populateStationList(searchInput.value);
            }
            
            // --- VISUALIZER SETUP ---
            let scene, camera, renderer, vizObject;

            function initVisualizer() {
                if (visualizerInitialized) return;

                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    analyser = audioContext.createAnalyser();
                    sourceNode = audioContext.createMediaElementSource(audioPlayer);
                    
                    sourceNode.connect(analyser);
                    analyser.connect(audioContext.destination);
                    
                    scene = new THREE.Scene();
                    camera = new THREE.PerspectiveCamera(75, visualizerContainer.clientWidth / visualizerContainer.clientHeight, 0.1, 1000);
                    renderer = new THREE.WebGLRenderer({ alpha: true });
                    renderer.setSize(visualizerContainer.clientWidth, visualizerContainer.clientHeight);
                    visualizerContainer.innerHTML = '';
                    visualizerContainer.appendChild(renderer.domElement);

                    setupVisualization(currentViz);
                    animate();
                    visualizerInitialized = true;
                } catch (e) {
                    console.error("Visualizer initialization failed:", e);
                    showInitialIcon();
                }
            }

            function setupVisualization(vizType) {
                if (vizObject) scene.remove(vizObject);

                if (vizType === 'sphere') {
                    const geometry = new THREE.IcosahedronGeometry(1.2, 1);
                    const material = new THREE.MeshNormalMaterial({ wireframe: true });
                    vizObject = new THREE.Mesh(geometry, material);
                    camera.position.z = 3;
                } else if (vizType === 'bars') {
                    analyser.fftSize = 256;
                    const group = new THREE.Group();
                    const barCount = 64;
                    for (let i = 0; i < barCount; i++) {
                        const geometry = new THREE.BoxGeometry(0.25, 0.1, 0.25);
                        const material = new THREE.MeshNormalMaterial();
                        const bar = new THREE.Mesh(geometry, material);
                        bar.position.x = (i - barCount / 2) * 0.4;
                        group.add(bar);
                    }
                    vizObject = group;
                    camera.position.set(0, 0, 5);
                    camera.lookAt(0,0,0);
                } else if (vizType === 'wave') {
                    analyser.fftSize = 2048;
                    const geometry = new THREE.PlaneGeometry(5, 5, 64, 32);
                    const material = new THREE.MeshNormalMaterial({ wireframe: true });
                    vizObject = new THREE.Mesh(geometry, material);
                    camera.position.set(0, 2, 3);
                    camera.lookAt(0,0,0);
                }
                scene.add(vizObject);
            }

            function animate() {
                requestAnimationFrame(animate);
                if (audioPlayer.paused) {
                    if(currentViz === 'sphere' && vizObject) {
                        vizObject.rotation.y += 0.001;
                    }
                    renderer.render(scene, camera);
                    return;
                }

                if (currentViz === 'sphere') {
                    analyser.fftSize = 256;
                    const bufferLength = analyser.frequencyBinCount;
                    const dataArray = new Uint8Array(bufferLength);
                    analyser.getByteFrequencyData(dataArray);
                    const avgFrequency = dataArray.reduce((sum, value) => sum + value, 0) / bufferLength;
                    const scale = 1 + (avgFrequency / 256) * 0.8;
                    vizObject.scale.set(scale, scale, scale);
                    vizObject.rotation.x += 0.005;
                    vizObject.rotation.y += 0.005;
                } else if (currentViz === 'bars') {
                    analyser.fftSize = 256;
                    const bufferLength = analyser.frequencyBinCount;
                    const dataArray = new Uint8Array(bufferLength);
                    analyser.getByteFrequencyData(dataArray);
                    vizObject.children.forEach((bar, i) => {
                        const scale = 0.1 + (dataArray[i] / 255) * 15;
                        bar.scale.y = scale;
                    });
                } else if (currentViz === 'wave') {
                    analyser.fftSize = 2048;
                    const bufferLength = analyser.frequencyBinCount;
                    const dataArray = new Uint8Array(bufferLength);
                    analyser.getByteTimeDomainData(dataArray);
                    const positions = vizObject.geometry.attributes.position;
                    for (let i = 0; i < positions.count; i++) {
                        const index = Math.floor((i % (65)) / 65 * bufferLength);
                        const v = dataArray[index] / 128.0;
                        positions.setZ(i, (v - 1) * 2.5);
                    }
                    positions.needsUpdate = true;
                }

                renderer.render(scene, camera);
            }
            
            function showInitialIcon() {
                 visualizerContainer.innerHTML = `
                    <div class="w-32 h-32 bg-gray-200/50 dark:bg-slate-700/50 rounded-full flex items-center justify-center transition-colors duration-300">
                        <i class="fas fa-radio text-6xl text-gray-400 dark:text-slate-400"></i>
                    </div>`;
            }

            function setupMetadata(station) {
                if (metadataPlayer) {
                    metadataPlayer.disconnect();
                }
                infoGenre.textContent = station.genre;
                
                if (typeof IcecastMetadataPlayer === 'undefined') {
                    console.error("IcecastMetadataPlayer library not loaded.");
                    return;
                }

                const Player = IcecastMetadataPlayer.default;

                metadataPlayer = new Player(station.url, {
                    onMetadata: (metadata) => {
                        infoGenre.textContent = metadata.StreamTitle ? metadata.StreamTitle : station.genre;
                    },
                    audioElement: audioPlayer,
                });
            }

            // --- UI POPULATION AND UPDATES ---
            function populateStationList(filter = '') {
                const searchTerm = filter.toLowerCase();
                
                stations.sort((a, b) => {
                    if (a.isFavorite && !b.isFavorite) return -1;
                    if (!a.isFavorite && b.isFavorite) return 1;
                    return 0;
                });

                let filteredStations = stations.filter(station => station.name.toLowerCase().includes(searchTerm) || station.genre.toLowerCase().includes(searchTerm));
                
                let stationsToRender = isLazyLoadingEnabled ? filteredStations.slice(0, stationsToShow) : filteredStations;

                stationList.innerHTML = '';
                stationsToRender.forEach((station, index) => {
                        const stationDiv = document.createElement('div');
                        stationDiv.className = 'station-item w-full text-left p-4 border-b border-white/10 dark:border-slate-700/50 hover:bg-white/30 dark:hover:bg-slate-700/50 transition-colors duration-200 flex items-center justify-between';
                        stationDiv.dataset.stationName = station.name;
                        
                        const leftContainer = document.createElement('div');
                        leftContainer.className = 'flex items-center flex-grow min-w-0';
                        
                        const clickArea = document.createElement('div');
                        clickArea.className = 'flex items-center cursor-pointer flex-grow min-w-0';

                        const dragHandle = document.createElement('span');
                        dragHandle.className = 'drag-handle';
                        dragHandle.innerHTML = '<i class="fas fa-grip-vertical"></i>';

                        const textContainer = document.createElement('div');
                        textContainer.className = "min-w-0";
                        const name = document.createElement('span');
                        name.className = 'font-semibold block truncate';
                        name.textContent = station.name;
                        const genre = document.createElement('span');
                        genre.className = 'block text-sm text-slate-500 dark:text-slate-400';
                        genre.textContent = station.genre;
                        textContainer.appendChild(name);
                        textContainer.appendChild(genre);

                        clickArea.appendChild(dragHandle);
                        clickArea.appendChild(textContainer);
                        
                        leftContainer.appendChild(clickArea);

                        const favoriteButton = document.createElement('button');
                        favoriteButton.className = 'favorite-btn p-2 ml-2 flex-shrink-0';
                        favoriteButton.title = 'Toggle Favorite';
                        favoriteButton.innerHTML = `<i class="fa-star ${station.isFavorite ? 'fas favorited' : 'far'} favorite-star"></i>`;
                        favoriteButton.dataset.stationName = station.name;

                        stationDiv.appendChild(leftContainer);
                        stationDiv.appendChild(favoriteButton);
                        stationList.appendChild(stationDiv);
                    });
            }
            
            function initSortable() {
                new Sortable(stationList, {
                    animation: 150,
                    handle: '.drag-handle',
                    ghostClass: 'sortable-ghost',
                    onEnd: function (evt) {
                        const movedItem = stations.splice(evt.oldIndex, 1)[0];
                        stations.splice(evt.newIndex, 0, movedItem);
                        saveOrder();
                        populateStationList(searchInput.value);
                    },
                });
            }
            
            // --- EVENT LISTENERS ---
            stationList.addEventListener('click', (event) => {
                const favoriteBtn = event.target.closest('.favorite-btn');
                if (favoriteBtn) {
                    event.stopPropagation();
                    toggleFavorite(favoriteBtn.dataset.stationName);
                    return;
                }

                const stationItem = event.target.closest('.station-item');
                if (stationItem) {
                    const stationName = stationItem.dataset.stationName;
                    const selectedStation = stations.find(s => s.name === stationName);

                    if (!selectedStation) return;
                    currentStation = selectedStation;

                    document.querySelectorAll('.station-item.active').forEach(item => {
                        item.classList.remove('active');
                        const genreEl = item.querySelector('.text-sm');
                        genreEl.classList.remove('text-white', 'dark:text-white');
                        genreEl.classList.add('text-slate-500', 'dark:text-slate-400');
                    });
                    stationItem.classList.add('active');
                    const genreEl = stationItem.querySelector('.text-sm');
                    genreEl.classList.add('text-white', 'dark:text-white');
                    genreEl.classList.remove('text-slate-500', 'dark:text-slate-400');


                    infoName.textContent = selectedStation.name;
                    infoQuality.textContent = `Quality: ${selectedStation.quality}`;
                    audioPlayer.src = selectedStation.url;
                    audioPlayer.play().catch(e => {
                        console.error("Playback failed:", e);
                        infoGenre.textContent = "Error: Stream could not be loaded.";
                        showInitialIcon();
                    });
                    
                    setupMetadata(selectedStation);
                }
            });
            
            audioPlayer.addEventListener('playing', () => {
                if (audioContext && audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                initVisualizer();
            });

            themeToggleButton.addEventListener('click', () => {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.theme = isDark ? 'dark' : 'light';
                updateThemeIcons();
            });

            vizSelect.addEventListener('change', (e) => {
                currentViz = e.target.value;
                localStorage.setItem('radioViz', currentViz);
                if (visualizerInitialized) {
                    setupVisualization(currentViz);
                }
            });

            searchInput.addEventListener('input', (e) => {
                if(e.target.value) {
                    isLazyLoadingEnabled = false;
                } else {
                    isLazyLoadingEnabled = true;
                    stationsToShow = 10;
                }
                populateStationList(e.target.value);
            });

            stationList.addEventListener('scroll', () => {
                if (isLazyLoadingEnabled && stationList.scrollTop + stationList.clientHeight >= stationList.scrollHeight - 50) {
                    const filteredStations = stations.filter(station => station.name.toLowerCase().includes(searchInput.value.toLowerCase()) || station.genre.toLowerCase().includes(searchInput.value.toLowerCase()));
                    if (stationsToShow < filteredStations.length) {
                        stationsToShow += 10;
                        populateStationList(searchInput.value);
                    }
                }
            });
            
            function updateThemeIcons() {
                const isDark = document.documentElement.classList.contains('dark');
                themeToggleButton.querySelector('.fa-sun').classList.toggle('hidden', isDark);
                themeToggleButton.querySelector('.fa-moon').classList.toggle('hidden', !isDark);
            }

            // --- INITIALIZATION ---
            showInitialIcon();
            loadStoredData();
            populateStationList();
            updateThemeIcons();
            initSortable();
        });
    </script>

</body>
</html>
